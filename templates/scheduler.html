<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>On-Call Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .calendar-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .calendar-day { min-height: 160px; position: relative; }
        .weekend-day.preference-possible:hover { background-color: #374151; }
        .preference-rank {
            position: absolute; top: 2px; right: 4px; background-color: #4f46e5;
            color: white; border-radius: 9999px; width: 1.5rem; height: 1.5rem;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-4 sm:p-6 md:p-8">
    <div class="max-w-screen-2xl mx-auto">
        <header class="text-center mb-8"><h1 class="text-3xl md:text-4xl font-bold text-indigo-400">On-Call Schedule</h1></header>
        <main class="flex flex-col xl:flex-row gap-8">
            <div class="w-full xl:flex-1 bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg">
                <div class="flex items-center justify-between mb-6">
                    <button id="prev-month-btn" class="px-4 py-2 bg-indigo-600 rounded-md">&larr; Prev</button>
                    <h2 id="current-month-year" class="text-xl sm:text-2xl font-semibold text-center mx-2"></h2>
                    <button id="next-month-btn" class="px-4 py-2 bg-indigo-600 rounded-md">&rarr;</button>
                </div>
                <div class="grid calendar-grid gap-1 text-center font-bold text-gray-400 mb-2">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendar-grid" class="grid calendar-grid gap-1 md:gap-2"></div>
            </div>
            <div class="w-full xl:w-96 bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col space-y-4">
                <div>
                     <h3 class="text-xl font-semibold border-b border-gray-700 pb-3 mb-4">My Preferences</h3>
                     <label for="team-member-select" class="block mb-2 font-medium">1. Select Your Name</label>
                     <select id="team-member-select" class="w-full p-2 bg-gray-700 rounded-md"></select>
                    <div id="preference-info" class="hidden mt-4 text-center p-4 bg-gray-900 rounded-md">
                        <p class="text-gray-400">Click on-call days in the calendar in your preferred order.</p>
                    </div>
                    <div id="preference-list-container" class="hidden flex-grow space-y-2 mt-4">
                        <h4 class="font-medium">Your Ranked Preferences:</h4>
                        <ol id="preference-list" class="list-decimal list-inside p-2 bg-gray-900 rounded-md min-h-[8rem] overflow-y-auto"></ol>
                        <button id="save-prefs-btn" class="w-full py-2 px-4 bg-green-600 rounded-md font-semibold">Save My Preferences</button>
                    </div>
                </div>
                <div class="border-t border-gray-700 pt-4">
                    <h3 class="text-xl font-semibold pb-3">Team Priorities This Month</h3>
                    <div id="team-priorities-list" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                </div>
                <div class="mt-auto text-center !mt-8"><a href="/admin" class="text-indigo-400 hover:underline">Go to Admin Dashboard</a></div>
            </div>
        </main>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let currentDate = new Date();
        let assignments = {};
        let groups = [];
        let holidays = new Set();
        let allEngineers = [];
        let selectedEngineer = null;
        let currentPreferences = [];
        let unsavedPreferences = {};

        const DOM = { /* DOM element references */ 
            calendarGrid: document.getElementById('calendar-grid'),
            currentMonthYear: document.getElementById('current-month-year'),
            prevMonthBtn: document.getElementById('prev-month-btn'),
            nextMonthBtn: document.getElementById('next-month-btn'),
            teamMemberSelect: document.getElementById('team-member-select'),
            preferenceInfo: document.getElementById('preference-info'),
            preferenceListContainer: document.getElementById('preference-list-container'),
            preferenceList: document.getElementById('preference-list'),
            savePrefsBtn: document.getElementById('save-prefs-btn'),
            teamPrioritiesList: document.getElementById('team-priorities-list'),
        };

        const getMonthString = (d) => `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`;
        async function apiCall(url, method = 'GET', body = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (body) options.body = JSON.stringify(body);
            const response = await fetch(url, options);
            if (!response.ok) { const err = await response.json(); throw new Error(err.error || 'API request failed'); }
            return response.json();
        }

        /** Master function to update the app's state from any server response */
        function updateStateFromData(data) {
            assignments = data.assignments || {};
            groups = data.groups || [];
            holidays = new Set(data.holidays || []);
            allEngineers = groups.flat();
        }

        async function loadStateFromServer() {
            try {
                const data = await apiCall(`/api/data?month=${getMonthString(currentDate)}`);
                updateStateFromData(data);
            } catch (error) { console.error('Error loading data:', error); }
        }

        function populateDropdown() {
            const currentSelection = DOM.teamMemberSelect.value;
            DOM.teamMemberSelect.options.length = 0;
            DOM.teamMemberSelect.add(new Option('-- Select Your Name --', ''));
            allEngineers.sort((a,b) => a.name.localeCompare(b.name)).forEach(eng => {
                DOM.teamMemberSelect.add(new Option(eng.name, eng.name));
            });
            DOM.teamMemberSelect.value = currentSelection || '';
        }

        function renderCalendar() {
            // This function is unchanged and correct from the previous version
            DOM.calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            DOM.currentMonthYear.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) DOM.calendarGrid.insertAdjacentHTML('beforeend', '<div></div>');
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = `${getMonthString(date)}-${date.getDate().toString().padStart(2, '0')}`;
                const isOnCallDay = date.getDay() === 0 || date.getDay() === 6 || holidays.has(dateString);
                let dayCellHTML;
                if (isOnCallDay) {
                    const assigned = assignments[dateString] || [];
                    const namesHTML = assigned.map((name, i) => `<div class="text-xs truncate">${i+1}. ${name}</div>`).join('');
                    const isHighlighted = selectedEngineer && assigned.includes(selectedEngineer);
                    const prefIndex = currentPreferences.indexOf(dateString);
                    const prefRankHTML = prefIndex > -1 ? `<div class="preference-rank">${prefIndex + 1}</div>` : '';
                    dayCellHTML = `<div class="calendar-day p-2 border border-gray-700/50 rounded-md flex flex-col bg-gray-800 weekend-day ${selectedEngineer ? 'preference-possible cursor-pointer' : ''} ${isHighlighted ? 'ring-2 ring-blue-500' : ''}" data-date="${dateString}">${prefRankHTML}<div class="font-bold text-indigo-300">${day}</div><div class="mt-1 space-y-1 overflow-hidden flex-grow">${namesHTML}</div></div>`;
                } else {
                    dayCellHTML = `<div class="p-2"><div class="font-bold text-gray-500">${day}</div></div>`;
                }
                DOM.calendarGrid.insertAdjacentHTML('beforeend', dayCellHTML);
            }
        }

        function renderPreferences() {
            DOM.preferenceList.innerHTML = '';
            currentPreferences.forEach((date, i) => {
                const li = document.createElement('li');
                li.textContent = `${i + 1}. ${date}`;
                DOM.preferenceList.appendChild(li);
            });
        }
        
        function renderTeamPriorities() {
            DOM.teamPrioritiesList.innerHTML = '';
            groups.forEach((group, i) => {
                const groupHTML = `<div class="bg-gray-900 p-3 rounded-md"><h4 class="font-semibold text-green-400 mb-2">Group ${i + 1} ${i === 0 ? '(Highest)' : ''}</h4><ol class="list-decimal list-inside text-sm space-y-1">${group.map(eng => `<li>${eng.name}</li>`).join('')}</ol></div>`;
                DOM.teamPrioritiesList.insertAdjacentHTML('beforeend', groupHTML);
            });
        }

        function updatePreferenceViewForSelectedEngineer() {
            DOM.preferenceInfo.classList.toggle('hidden', !selectedEngineer);
            DOM.preferenceListContainer.classList.toggle('hidden', !selectedEngineer);
            const monthStr = getMonthString(currentDate);
            if (selectedEngineer && unsavedPreferences[selectedEngineer] && unsavedPreferences[selectedEngineer][monthStr]) {
                currentPreferences = unsavedPreferences[selectedEngineer][monthStr];
            } else if (selectedEngineer) {
                const engData = allEngineers.find(eng => eng.name === selectedEngineer);
                currentPreferences = (engData?.preferences || {})[monthStr] || [];
            } else {
                currentPreferences = [];
            }
            renderPreferences();
        }

        DOM.teamMemberSelect.addEventListener('change', (e) => {
            selectedEngineer = e.target.value;
            updatePreferenceViewForSelectedEngineer();
            renderCalendar();
        });

        DOM.calendarGrid.addEventListener('click', (e) => {
            if (!selectedEngineer) return;
            const cell = e.target.closest('.weekend-day');
            if (!cell) return;
            const date = cell.dataset.date;
            const prefIndex = currentPreferences.indexOf(date);
            if (prefIndex > -1) { currentPreferences.splice(prefIndex, 1); } 
            else { currentPreferences.push(date); }
            if (!unsavedPreferences[selectedEngineer]) unsavedPreferences[selectedEngineer] = {};
            unsavedPreferences[selectedEngineer][getMonthString(currentDate)] = currentPreferences;
            renderPreferences();
            renderCalendar();
        });

        DOM.savePrefsBtn.addEventListener('click', async () => {
            if (!selectedEngineer) return;
            const monthStr = getMonthString(currentDate);
            try {
                // FIXED: API call now returns the full updated state
                const data = await apiCall('/api/preferences', 'POST', {
                    engineer: selectedEngineer,
                    month: monthStr,
                    preferences: currentPreferences
                });
                // FIXED: Update state directly from the reliable server response
                updateStateFromData(data);
                if (unsavedPreferences[selectedEngineer]?.[monthStr]) {
                    delete unsavedPreferences[selectedEngineer][monthStr];
                }
                alert('Your preferences have been saved!');
            } catch(error) { alert(`Error: ${error.message}`); }
        });

        DOM.prevMonthBtn.addEventListener('click', async () => { currentDate.setMonth(currentDate.getMonth() - 1); await initializeApp(); });
        DOM.nextMonthBtn.addEventListener('click', async () => { currentDate.setMonth(currentDate.getMonth() + 1); await initializeApp(); });

        async function initializeApp() {
            await loadStateFromServer();
            populateDropdown();
            updatePreferenceViewForSelectedEngineer(); 
            renderCalendar();
            renderTeamPriorities();
        }

        initializeApp();
    });
    </script>
</body>
</html>